# ПЛАН ДОРАБОТКИ AziaCRM ПО ТЗ ДИРЕКТОРА

> Задание для Claude Code на VPS. Выполнять последовательно по блокам.
> Проект: `/opt/aziacrm` (backend — FastAPI, frontend — Next.js + shadcn/ui + recharts)
> БД: SQLite (`backend/aziacrm.db`)

---

## ЧТО УЖЕ РЕАЛИЗОВАНО (НЕ ТРОГАТЬ):

### Карточка заказа (OrderSheet.tsx) — ~90% полей из ТЗ уже есть:
- **Основное**: Счёт №, дата счета, Заказ клиента №, дата заказа, клиент (поиск из базы), тип транспорта, способ загрузки, описание груза
- **Маршрут**: Страна/город загрузки и выгрузки, дата загрузки/выгрузки, адреса, ПТО/таможня, генерация маршрута строкой, **мультиточки маршрута** (route_points — загрузка/выгрузка с N точками)
- **Финансы**: Стоимость + валюта (RUB/BYN/USD/EUR/KZT/CNY), НДС (0%/10%/20%/Без), автовычисление итого с НДС, дней на оплату, тип дней, дата отсчёта
- **Исполнение**: Поиск перевозчика из базы, выбор авто из автопарка (тягач+прицеп), выбор водителя из списка, дата CMR, № CMR
- **Менеджеры**: Назначение нескольких менеджеров из списка пользователей
- **Файлы**: Загрузка/скачивание/удаление файлов к заказу
- **Документы**: Генерация заявки (2 типа), счёта (3 типа), акта из шаблонов Word
- **Дополнительно**: Дубликат заказа, защита от дубликатов номера счета, автономера счетов

### Карточка клиента (ClientSheet) — базовые поля:
- Название, УНП, ФИО (полное), локация, контакты, заметки
- Договор (№, дата), условия оплаты (дни, тип)
- Юр/почт/факт адреса, банк реквизиты, подписант, преамбула, реквизиты для документов
- Файлы, менеджеры, бан-флаг
- Генерация документов (договор, конверт)

### Карточка перевозчика (CarrierSheet) — базовые поля:
- Название, УНП, ФИО, локация, контакты, автопарк, кузов, маршрут, объем
- CMR/ADR/Сборный флаги, заметки
- Договор, условия оплаты, адреса, банк реквизиты
- **Автопарк** (fleet_list): тягачи + прицепы с маркой и номером
- **Водители** (drivers_list): ФИО + детали
- Файлы, бан-флаг, генерация документов

### Рабочее пространство (workspace) — 4 вкладки:
1. **Перевозчики** — таблица с фильтрами (компания, телефон, локация, маршрут, кузов, объём, CMR, ADR, LTL), пагинация
2. **Клиенты** — таблица с поиском по названию/УНП
3. **Заказы клиентов** — таблица (дата, счёт №, клиент, маршрут, даты, груз, авто, сумма, оплата, статус) + расчёт дней до оплаты
4. **Заказы перевозчикам** — таблица с расчётом маржи в BYN (конверсия НБРБ в реальном времени)

### Что ещё уже работает:
- **Дашборд** (dashboard) — 10 виджетов с графиками, фильтрация по менеджеру
- **KPI** — таблица бонусов, % от маржи, перевыполнение плана, всё в BYN
- **Отчёты** — по клиентам, перевозчикам, водителям, ABC-анализ (всё в BYN)
- **КП генератор** — коммерческое предложение
- **Мессенджер** — внутренний чат между пользователями
- **Telegram-бот** — уведомления
- **SMTP email** — отправка паролей при регистрации
- **Права доступа** — admin видит всё, manager видит только свои заказы/клиентов
- **Activity log** — журнал действий
- **Задачи** (tasks) — CRUD с назначением на пользователя
- **Конверсия валют** — НБРБ API с кешем 1 час во всех финансовых расчётах

---

## ЧТО НУЖНО ДОРАБОТАТЬ:

---

### БЛОК 1. ВОРОНКА 7 ЭТАПОВ (приоритет: ВЫСОКИЙ)

**Текущее**: Произвольные текстовые статусы (из elogistic). Список в OrderSheet: "Получен заказ", "В пути", "Выгружен", "Документы отправлены", "Частичная оплата", "Оплачен"

**Нужно**: Фиксированная 7-этапная воронка:

| # | Этап | Описание |
|---|------|----------|
| 1 | Новая заявка | 12 полей заполнены |
| 2 | КП отправлено | Ставка рассчитана, КП отправлено |
| 3 | Подтверждена | Клиент согласовал ставку |
| 4 | В работе | Перевозчик назначен, загружен |
| 5 | Доставлен | Груз выгружен, CMR подписана |
| 6 | Документы | Счёт выставлен, оригиналы в пути |
| 7 | Оплачен | Клиент и перевозчик оплачены |

**Задачи:**
1. В `backend/app/models.py` — добавить константу `ORDER_STAGES = [...]`
2. В `OrderSheet.tsx` — заменить Select статуса на **визуальный stepper** (7 шагов горизонтально, кликабельный)
3. В `frontend/components/OrderSheet.tsx` строка 33 — обновить `STATUSES` массив
4. Добавить валидацию: нельзя перескочить через этап (только +1 вперёд или назад)
5. В таблице заказов (workspace) — цветовые бейджи для каждого этапа
6. На дашборде — виджет "Воронка CRM" (BarChart по этапам)
7. **Маппинг старых статусов** (для существующих ~3900 заказов из elogistic):
```
"Получен заказ", "Принят заказ" → "Новая заявка"
"Загружен" → "В работе"
"Выгружен" → "Доставлен"
"Акт выставлен" → "Документы"
"Оплачен", "Частичная оплата" → "Оплачен"
"Отменён" → отдельный статус (вне воронки)
```

---

### БЛОК 2. НЕДОСТАЮЩИЕ ПОЛЯ ЗАКАЗА (приоритет: СРЕДНИЙ)

**Что уже есть**: weight, volume_val, cargo_description, cost, currency, carrier_cost, carrier_currency, loading_date, delivery_deadline, cmr_date, cmr_number, files_list

**Чего не хватает** (новые колонки в `Order`, ALTER TABLE):

```python
# Финансы — автовычисляемые
carrier_cost = Column(String)          # УЖЕ ЕСТЬ
carrier_currency = Column(String)      # УЖЕ ЕСТЬ
margin_amount = Column(String)         # НОВОЕ — Маржа (cost_byn - carrier_cost_byn)
margin_percent = Column(String)        # НОВОЕ — Маржа % (margin / cost * 100)
carrier_payment_date = Column(String)  # НОВОЕ — Дата оплаты перевозчику
client_invoice_num = Column(String)    # НОВОЕ — Счёт № клиенту
carrier_invoice_num = Column(String)   # НОВОЕ — Счёт № перевозчику

# Трекинг
loading_date_fact = Column(String)     # НОВОЕ — Фактическая дата загрузки
unloading_date_fact = Column(String)   # НОВОЕ — Фактическая дата выгрузки
gps_status = Column(Text)             # НОВОЕ — Статус местоположения
transit_points = Column(Text)         # НОВОЕ — Транзитные точки (границы)

# Документы
originals_received = Column(Boolean)  # НОВОЕ — Оригиналы получены (Да/Нет)

# Заявка (дополнительные)
cargo_value = Column(String)          # НОВОЕ — Стоимость груза (для страховки)
temperature = Column(String)          # НОВОЕ — Температурный режим (рефрижератор)
adr_class = Column(String)            # НОВОЕ — ADR класс опасности
pallets_count = Column(String)        # НОВОЕ — Кол-во паллет
client_source = Column(String)        # НОВОЕ — Источник заявки (звонок/тендер/сайт/рек.)
```

**Задачи:**
1. ALTER TABLE для каждого нового поля
2. Обновить `schemas.py` (OrderCreate, OrderOut)
3. Обновить `types/index.ts` (Order interface)
4. В `OrderSheet.tsx` — добавить поля в секции:
   - Секция "Заявка": cargo_value, temperature, adr_class, pallets_count, client_source
   - Секция "Финансы": margin_amount (readonly), margin_percent (readonly), carrier_payment_date
   - Секция "Трекинг": loading_date_fact, unloading_date_fact, gps_status, transit_points
   - Секция "Документы": originals_received (checkbox)
5. **Автовычисление маржи** в backend при сохранении: конвертация обеих сумм в BYN через НБРБ, margin = cost_byn - carrier_cost_byn, percent = margin / cost_byn * 100
6. **Блокировка этапа 3 при марже < 15%** — уведомление руководителю

---

### БЛОК 3. НЕДОСТАЮЩИЕ ПОЛЯ КЛИЕНТА (приоритет: СРЕДНИЙ)

**Что есть**: name, unp, full_name, contact, location, notes, contract_num/date, payment_cond/days/type, адреса, банк, подписант, файлы, менеджеры, is_banned

**Чего не хватает**:
```python
client_type = Column(String)         # Тип: прямой / тендер / агент
source = Column(String)              # Источник: звонок / тендер / сайт / рек. / ATI
lpr_name = Column(String)            # ЛПР ФИО
lpr_phone = Column(String)           # Телефон ЛПР
lpr_email = Column(String)           # Email ЛПР
nps_score = Column(Integer)          # NPS 0-10
ltv = Column(String)                 # LTV — маржа за всё время (автовычисление)
last_order_date = Column(String)     # Дата последнего рейса (автовычисление)
```

**Задачи:**
1. ALTER TABLE + models.py + schemas.py
2. Обновить `types/index.ts` (Client interface)
3. В `ClientSheet` — добавить поля ЛПР (ФИО, тел, email), тип, источник, NPS
4. Автовычисление LTV (сумма маржи по всем заказам клиента) и last_order_date

---

### БЛОК 4. НЕДОСТАЮЩИЕ ПОЛЯ ПЕРЕВОЗЧИКА (приоритет: СРЕДНИЙ)

**Что есть**: name, unp, contact, fleet_size, trailer, route, volume, cmr, adr, groupage, notes, is_banned, drivers_list, fleet_list, файлы

**Чего не хватает**:
```python
rating = Column(String, default="B")         # Рейтинг: A / B / C
avg_rate = Column(String)                    # Средняя ставка
total_trips = Column(Integer, default=0)     # Кол-во рейсов (автовычисление)
quality_percent = Column(String)             # % рейсов без претензий (автовычисление)
dispatcher_phone = Column(String)            # Телефон диспетчера
blacklist_reason = Column(Text)              # Причина блокировки (if is_banned)
```

**Задачи:**
1. ALTER TABLE + models.py + schemas.py
2. Обновить `types/index.ts` (Carrier interface)
3. В `CarrierSheet` — добавить: рейтинг A/B/C (Select), телефон диспетчера, причина блокировки
4. Автовычисление total_trips и quality_percent из заказов
5. **Блокировка назначения перевозчика из чёрного списка** — предупреждение в OrderSheet при выборе забаненного перевозчика

---

### БЛОК 5. РАСШИРЕННЫЕ РОЛИ — 6 РОЛЕЙ (приоритет: ВЫСОКИЙ)

**Текущее**: 2 роли — admin и manager. Фильтрация: manager видит только свои заказы/клиентов

**Нужно** — 6 ролей:

| Роль | Код | Воронка | Контакты | Отчёты |
|------|-----|---------|----------|--------|
| Собственник | owner | Просмотр всех (read-only) | Просмотр всех | Все дашборды |
| Руководитель | admin | Полный доступ | Полный доступ | Все + выгрузки |
| Менеджер входящих | incoming | Создание + этап 1-2 | Создание клиентов | Свои KPI |
| Тендер-специалист | tender | Свои заказы | Свои клиенты | Свои KPI |
| Хантер | hunter | Свои заказы | Свои клиенты | Свои KPI |
| Фармер | farmer | Этапы 2-7 (свои) | Свои клиенты + все ТС | Свои KPI |
| Документовед | docs | Этапы 5-7 (все) | Просмотр всех | Финансовые |

**Задачи:**
1. В `models.py` — расширить допустимые значения role
2. В `dependencies.py` — обновить `get_current_user`, добавить проверки прав
3. Во всех роутерах — фильтрация по ролям:
   - `owner` — только чтение, без редактирования
   - `incoming` — только создание + этапы 1-2
   - `farmer` — этапы 2-7 своих заказов
   - `docs` — этапы 5-7 всех заказов
4. Frontend — скрывать/показывать элементы в зависимости от роли
5. Настройки пользователей — dropdown роли с 6 вариантами

---

### БЛОК 6. АВТОМАТИЗАЦИИ — 12 СЦЕНАРИЕВ (приоритет: ВЫСОКИЙ)

**Что есть**: Telegram-бот, notifications API, tasks API, activity log

**Нужно реализовать**:

| # | Триггер | Действие |
|---|---------|----------|
| 1 | Новая заявка создана | Telegram + уведомление менеджеру. Таймер 15 мин на обработку |
| 2 | Этап → "КП отправлено" | Автозадача "Дожим через 24 ч" ответственному |
| 3 | Этап → "Подтверждена" | Автозадача "Найти перевозчика" фармеру |
| 4 | Маржа < 15% | Уведомление руководителю + блокировка перехода |
| 5 | Маржа < 12% (тендер) | Уведомление + требование согласования |
| 6 | Этап → "Доставлен" | Автозадача "Выставить счёт" документоведу |
| 7 | Счёт не оплачен 14+ дней | Задача "Напоминание клиенту" фармеру |
| 8 | Счёт не оплачен 30+ дней | Эскалация руководителю |
| 9 | Клиент неактивен 30+ дней | Задача "Реактивация" фармеру |
| 10 | Пятница 17:00 | Автозапрос статистик у всех |
| 11 | Новый перевозчик добавлен | Задача "Проверить документы" |
| 12 | Смена статуса заказа | Уведомление + activity log |

**Задачи:**
1. Создать `backend/app/automations.py` — движок автоматизаций
2. При смене статуса в `orders.py` (update endpoint) — вызывать триггеры
3. Фоновый scheduler (APScheduler) для: просроченных счетов (каждый час), пятничных запросов, неактивных клиентов (ежедневно)
4. Интеграция с Telegram и notifications

---

### БЛОК 7. ДАШБОРД РУКОВОДИТЕЛЯ (приоритет: ВЫСОКИЙ)

**Что есть**: Базовый дашборд (10 виджетов) на `/`

**Нужно**: Новый дашборд руководителя по макету `Дашборд_Руководителя.jsx`:

| # | Виджет |
|---|--------|
| 1 | TOP KPI: Маржа/нед (число+тренд), % плана, Рейсов/нед, Активных клиентов |
| 2 | AreaChart: Динамика маржи 7 недель |
| 3 | BarChart: Воронка CRM — сделки по 7 этапам |
| 4 | 7 отделений — статус KPI (полоса из 7 карточек) |
| 5 | Маржинальность по типам (тендеры/прямые/новые) — прогресс-бары |
| 6 | Сотрудники — таблица: имя, роль, KPI, тренд |
| 7 | Рейсы и претензии — двойная BarChart |

**Задачи:**
1. Новый эндпоинт `GET /dashboard/director`
2. Новая страница `frontend/app/director/page.tsx`
3. Реализовать по JSX-макету (recharts, цвета бордо `#6B2D3E`)
4. Доступ: только admin и owner

---

### БЛОК 8. ДАШБОРД СОБСТВЕННИКА (приоритет: СРЕДНИЙ)

4 виджета (read-only):
1. Маржа подразделения — месяц vs план
2. Просроченная ДЗ (красный если > 50K BYN)
3. Активных клиентов (с рейсом за 30 дней)
4. Тренд маржи 12 недель

**Задачи:**
1. Эндпоинт `GET /dashboard/owner`
2. Страница `frontend/app/owner/page.tsx`
3. Доступ: только owner

---

### БЛОК 9. НОВЫЕ ОТЧЁТЫ (приоритет: СРЕДНИЙ)

**Что есть**: отчёты по клиентам, перевозчикам, водителям, ABC

**Новые отчёты**:
- P&L по направлениям (группировка по странам) → `/reports/pnl`
- Маржинальность по типам клиентов → `/reports/margins`
- Дебиторская задолженность → `/reports/debts`
- Конверсия воронки (% перехода между этапами) → `/reports/funnel`
- Активность в CRM (действия по каждому сотруднику) → `/reports/activity`
- Чёрный список перевозчиков → `/reports/blacklist`

---

### БЛОК 10. ДОПОЛНИТЕЛЬНЫЕ ВОРОНКИ (приоритет: НИЗКИЙ)

- Воронка "Тендеры": Найден → Анализ → Расчёт → Подача → Ожидание → Выигран/Проигран
- Воронка "Холодные продажи": Звонок → ЛПР → КП → Дожим → Контракт

Добавить поле `pipeline` (reysy/tender/cold) в Order.

---

## ПОРЯДОК ВЫПОЛНЕНИЯ:

```
1. БЛОК 1 — Воронка 7 этапов + маппинг старых статусов
2. БЛОК 2 — Новые поля заказа (маржа, трекинг, документы)
3. БЛОК 5 — 6 ролей (зависит от воронки для ограничений по этапам)
4. БЛОК 6 — Автоматизации (зависит от воронки и ролей)
5. БЛОК 3 — Поля клиента (ЛПР, NPS, LTV)
6. БЛОК 4 — Поля перевозчика (рейтинг, чёрный список)
7. БЛОК 7 — Дашборд руководителя (зависит от воронки для виджета)
8. БЛОК 8 — Дашборд собственника
9. БЛОК 9 — Новые отчёты
10. БЛОК 10 — Доп. воронки
```

---

## ТЕХНИЧЕСКИЕ ЗАМЕЧАНИЯ:

1. **SQLite миграции**: `Base.metadata.create_all()` НЕ добавляет колонки. Для каждого нового поля: `ALTER TABLE orders ADD COLUMN field_name TYPE DEFAULT ''`
2. **НБРБ курсы**: уже есть `_fetch_nbrb_rates()` + `_to_byn()` в reports.py и kpi.py — использовать для маржи
3. **Telegram**: `backend/app/telegram_bot.py` — готов для уведомлений
4. **Activity log**: `backend/app/activity.py` — расширить для смены этапов
5. **Права**: фильтрация через `current_user.role != "admin"` — расширить на 6 ролей
6. **JSON поля**: `managers`, `permissions`, `files_list`, `drivers_list`, `fleet_list` — JSON в SQLite, парсить через Array.isArray()
7. **Кодировка**: `encoding='utf-8'` при чтении файлов в Python
8. **Frontend стек**: Next.js + shadcn/ui (Button, Input, Select, Sheet, Dialog, Tabs, Badge, Card) + recharts (AreaChart, BarChart, PieChart)
9. **API**: `frontend/lib/api.ts` — обёртка с JWT токеном (поле `token`, не `access_token`)
